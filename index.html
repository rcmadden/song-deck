<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <title>Song Deck</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="playlist-dropdown">
                <button class="playlist-btn" id="playlistBtn">
                    <h1>My Deck</h1>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <div class="playlist-panel" id="playlistPanel">
                    <a href="#" class="playlist-option" data-playlist="my-deck">My Deck</a>
                    <a href="#" class="playlist-option" data-playlist="8-track">8-Track</a>
                </div>
            </div>
            <div class="header-icons">
                <button class="theme-toggle" title="Toggle theme" id="themeToggle">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2V4M10 16V18M4 10H2M6.31 6.31L4.93 4.93M13.69 6.31L15.07 4.93M6.31 13.69L4.93 15.07M13.69 13.69L15.07 15.07M18 10H16M13 10A3 3 0 1 1 7 10A3 3 0 0 1 13 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <div class="account-dropdown">
                    <div class="account-section" title="Account">
                        <div class="account-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="15" stroke="currentColor" stroke-width="2"/>
                                <circle cx="16" cy="12" r="4" stroke="currentColor" stroke-width="2"/>
                                <path d="M8 24c0-4.4 3.6-8 8-8s8 3.6 8 8" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="account-name">Russia M</div>
                    </div>
                    <div class="account-panel" id="accountPanel">
                        <div class="account-option" id="profileOption">Profile</div>
                        <div class="account-option" id="billingOption">Billing</div>
                        <div class="account-option" id="themeOption">Light mode</div>
                        <div class="account-option" id="logoutOption">Log out</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="active-filters" id="activeFilters">
                <!-- Filter pills will be populated by JavaScript -->
            </div>
            <div class="filter-dropdown">
                <button class="filter-btn" id="filterBtn" title="Filter">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h14M6 10h8M8 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <div class="filter-panel" id="filterPanel">
                    <select id="filterKey" class="filter-select">
                        <option value="">All Keys</option>
                    </select>
                    <select id="filterArtist" class="filter-select">
                        <option value="">All Artists</option>
                    </select>
                    <select id="filterYear" class="filter-select">
                        <option value="">All Years</option>
                    </select>
                    <select id="filterEmA" class="filter-select">
                        <option value="">All Em&A</option>
                    </select>
                    <input type="text" id="searchSong" placeholder="Search songs..." class="filter-input">
                    <button id="clearFilters" class="clear-filters-btn">Clear All Filters</button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <table id="songTable">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="card"><span role="img" aria-label="Playing card">üÉè</span> <span class="sort-indicator">‚Üï</span></th>
                        <th class="sortable" data-sort="song">Song <span class="sort-indicator">‚Üï</span></th>
                        <th><span role="img" aria-label="Puzzle piece">üß©</span></th>
                        <th class="sortable" data-sort="key">üîë Key <span class="sort-indicator">‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="songTableBody">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div id="detailCard" class="detail-card hidden">
                <!-- Card details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // This will store our song data
        let songData = [];
        let filteredData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentPlaylist = 'my-deck';
        let activeFilters = {};

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            updateAccountThemeOption(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            updateAccountThemeOption(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeButton = document.getElementById('themeToggle');
            const icon = theme === 'dark' ? 
                `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 0 1 6.707 2.707a8.001 8.001 0 1 0 10.586 10.586z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>` :
                `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 2V4M10 16V18M4 10H2M6.31 6.31L4.93 4.93M13.69 6.31L15.07 4.93M6.31 13.69L4.93 15.07M13.69 13.69L15.07 15.07M18 10H16M13 10A3 3 0 1 1 7 10A3 3 0 0 1 13 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>`;
            themeButton.innerHTML = icon;
        }

        function updateAccountThemeOption(theme) {
            const themeOption = document.getElementById('themeOption');
            if (themeOption) {
                themeOption.textContent = theme === 'dark' ? 'Light mode' : 'Dark mode';
            }
        }

        // Account dropdown functionality
        function setupAccountDropdown() {
            const accountSection = document.querySelector('.account-section');
            const accountPanel = document.getElementById('accountPanel');
            
            if (accountSection && accountPanel) {
                accountSection.addEventListener('click', (e) => {
                    e.stopPropagation();
                    accountPanel.style.display = accountPanel.style.display === 'block' ? 'none' : 'block';
                });
                
                accountPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                document.getElementById('profileOption')?.addEventListener('click', () => {
                    alert('Profile functionality coming soon!');
                    accountPanel.style.display = 'none';
                });
                
                document.getElementById('billingOption')?.addEventListener('click', () => {
                    alert('Billing functionality coming soon!');
                    accountPanel.style.display = 'none';
                });
                
                document.getElementById('themeOption')?.addEventListener('click', () => {
                    toggleTheme();
                    accountPanel.style.display = 'none';
                });
                
                document.getElementById('logoutOption')?.addEventListener('click', () => {
                    alert('Logout functionality coming soon!');
                    accountPanel.style.display = 'none';
                });
            }
        }

        // Filter pill management
        function renderActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            if (!activeFiltersContainer) return;
            
            activeFiltersContainer.innerHTML = '';
            
            Object.entries(activeFilters).forEach(([key, value]) => {
                if (value) {
                    const pill = document.createElement('div');
                    pill.className = 'filter-pill';
                    
                    const filterName = key === 'searchSong' ? 'Search' : 
                                      key === 'filterKey' ? 'Key' :
                                      key === 'filterArtist' ? 'Artist' :
                                      key === 'filterYear' ? 'Year' :
                                      key === 'filterEmA' ? 'Em&A' : key;
                    
                    pill.innerHTML = `
                        <span>${filterName}: ${value}</span>
                        <button class="remove-filter" onclick="removeFilter('${key}')">√ó</button>
                    `;
                    
                    activeFiltersContainer.appendChild(pill);
                }
            });
        }

        function removeFilter(filterKey) {
            const element = document.getElementById(filterKey);
            if (element) {
                element.value = '';
                activeFilters[filterKey] = '';
                filterData();
                renderActiveFilters();
            }
        }

        // Function to get suit symbol based on index
        function getSuitSymbol(index, card) {
            if (index <= 0) {
                return 'üÉè';
            }
            
            if (index >= 1 && index <= 13) {
                return '‚ô£Ô∏è';
            } else if (index >= 14 && index <= 27) {
                return '‚ô¶Ô∏è';
            } else if (index >= 2 && index <= 40) {
                return '‚ô†Ô∏è';
            } else if (index >= 41 && index <= 53) {
                return '‚ô•Ô∏è';
            }
            
            return '‚ô£Ô∏è';
        }

        // Function to convert notes text to clickable links
      function convertNotesToLinks(notesText) {
        if (!notesText || typeof notesText !== 'string') return '';
        
        const parts = notesText.split(', ');
        const linkElements = [];
        
        parts.forEach(part => {
            part = part.trim();
            if (part.startsWith('http')) {
            const filename = part.split('/').pop();
            const displayName = filename.replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
            linkElements.push(`<li><a href="#" onclick="handleLinkClick(event); loadDocument('${part}', '${filename}'); return false;">${displayName}</a></li>`);
            } else if (part) {
            linkElements.push(`<li>${part}</li>`);
            }
        });
        
        if (linkElements.length > 0) {
            return `<ul>${linkElements.join('')}</ul>`;
        }
        return '';
        }

        function handleLinkClick(event) {
        // Remove active state from all links in this card
        document.querySelectorAll('.notes-links a').forEach(link => {
            link.classList.remove('active-link');
        });
        
        // Add active state to clicked link
        event.target.classList.add('active-link');
        }

        // Function to load and display document in the detail card
        function loadDocument(url, filename) {
            const documentViewer = document.getElementById('documentViewer');
            if (!documentViewer) return;
            
            documentViewer.style.display = 'block';
            const fileExtension = filename.split('.').pop().toLowerCase();
            
            if (fileExtension === 'pdf') {
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            } else if (['png', 'jpg', 'jpeg', 'gif', 'svg'].includes(fileExtension)) {
                documentViewer.innerHTML = `<img src="${url}" alt="${filename}" />`;
            } else if (fileExtension === 'md') {
                fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        const htmlContent = text
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/\n/g, '<br>');
                        
                        documentViewer.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
                    })
                    .catch(error => {
                        documentViewer.innerHTML = `<div class="markdown-content">Error loading document: ${error.message}</div>`;
                    });
            } else {
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            }
        }

        async function loadSongData() {
            try {
                const response = await fetch('songDB.csv');
                if (!response.ok) throw new Error('Network response was not ok');

                const csvText = await response.text();

                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                if (parsed.errors.length > 0) {
                    console.error('PapaParse errors:', parsed.errors);
                    parsed.errors.forEach(error => {
                        console.warn(`CSV parsing warning on row ${error.row}: ${error.message}`);
                    });
                }

                songData = parsed.data;
                
                currentPlaylist = 'my-deck';
                filteredData = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('My Deck');
                });
                
                populateFilters();
                renderSongTable();
                setupEventListeners();
            } catch (error) {
                console.error('Error loading song data:', error);
                document.getElementById('songTableBody').innerHTML = `
                    <tr><td colspan="4">‚ö†Ô∏è Error loading song data.</td></tr>`;
            }
        }

        function sortData(column) {
            if (column === 'card') {
                sortColumn = 'card';
                sortDirection = sortColumn === 'card' && sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
            }
            
            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'card') {
                    aVal = parseInt(a.Index) || 0;
                    bVal = parseInt(b.Index) || 0;
                } else if (column === 'song') {
                    aVal = (a.Title || '').toLowerCase();
                    bVal = (b.Title || '').toLowerCase();
                } else if (column === 'key') {
                    aVal = (a.Key || '').toLowerCase();
                    bVal = (b.Key || '').toLowerCase();
                } else if (column === 'artist') {
                    aVal = (a.Artist || '').toLowerCase();
                    bVal = (b.Artist || '').toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            updateSortIndicators();
            renderSongTable();
        }

        function updateSortIndicators() {
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '‚Üï';
                indicator.style.opacity = '0.5';
            });
            
            if (sortColumn) {
                const activeHeader = document.querySelector(`[data-sort="${sortColumn}"] .sort-indicator`);
                if (activeHeader) {
                    activeHeader.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                    activeHeader.style.opacity = '1';
                }
            }
        }

        function populateFilters() {
            let playlistSongs;
            if (currentPlaylist === '8-track') {
                playlistSongs = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('8-Track');
                });
            } else {
                playlistSongs = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('My Deck');
                });
            }
            
            const keys = [...new Set(playlistSongs.map(song => song.Key || '').filter(key => key))].sort();
            const artists = [...new Set(playlistSongs.map(song => song.Artist || '').filter(artist => artist))].sort();
            const years = [...new Set(playlistSongs.map(song => String(song.Date || '')).filter(date => date))].sort();
            const emAs = [...new Set(playlistSongs.map(song => song['Em&a'] || '').filter(ema => ema))].sort();
            
            const keySelect = document.getElementById('filterKey');
            if (keySelect) {
                keySelect.innerHTML = '<option value="">All Keys</option>';
                keys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    keySelect.appendChild(option);
                });
            }
            
            const artistSelect = document.getElementById('filterArtist');
            if (artistSelect) {
                artistSelect.innerHTML = '<option value="">All Artists</option>';
                artists.forEach(artist => {
                    const option = document.createElement('option');
                    option.value = artist;
                    option.textContent = artist;
                    artistSelect.appendChild(option);
                });
            }
            
            const yearSelect = document.getElementById('filterYear');
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">All Years</option>';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }
            
            const emASelect = document.getElementById('filterEmA');
            if (emASelect) {
                emASelect.innerHTML = '<option value="">All Em&A</option>';
                emAs.forEach(ema => {
                    const option = document.createElement('option');
                    option.value = ema;
                    option.textContent = ema;
                    emASelect.appendChild(option);
                });
            }
        }

        function filterData() {
            const keyFilter = document.getElementById('filterKey')?.value || '';
            const artistFilter = document.getElementById('filterArtist')?.value || '';
            const yearFilter = document.getElementById('filterYear')?.value || '';
            const emAFilter = document.getElementById('filterEmA')?.value || '';
            const searchFilter = document.getElementById('searchSong')?.value?.toLowerCase() || '';
            
            activeFilters = {
                filterKey: keyFilter,
                filterArtist: artistFilter,
                filterYear: yearFilter,
                filterEmA: emAFilter,
                searchSong: searchFilter
            };
            
            let playlistSongs;
            if (currentPlaylist === '8-track') {
                playlistSongs = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('8-Track');
                });
            } else {
                playlistSongs = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('My Deck');
                });
            }
            
            filteredData = playlistSongs.filter(song => {
                const keyMatch = !keyFilter || (song.Key || '') === keyFilter;
                const artistMatch = !artistFilter || (song.Artist || '') === artistFilter;
                const yearMatch = !yearFilter || String(song.Date || '') === yearFilter;
                const emAMatch = !emAFilter || (song['Em&a'] || '') === emAFilter;
                const searchMatch = !searchFilter || 
                    (song.Title || '').toLowerCase().includes(searchFilter) ||
                    (song.Artist || '').toLowerCase().includes(searchFilter);
                
                return keyMatch && artistMatch && yearMatch && emAMatch && searchMatch;
            });
            
            if (currentPlaylist === '8-track') {
                apply8TrackOrdering();
            }
            
            renderSongTable();
            renderActiveFilters();
            updateClearButtonStyle();
        }

        function hasActiveFilters() {
            return Object.values(activeFilters).some(value => value !== '');
        }

        function updateClearButtonStyle() {
            const clearButton = document.getElementById('clearFilters');
            if (clearButton) {
                if (hasActiveFilters()) {
                    clearButton.classList.add('has-filters');
                } else {
                    clearButton.classList.remove('has-filters');
                }
            }
        }

        function clearAllFilters() {
            document.getElementById('filterKey').value = '';
            document.getElementById('filterArtist').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterEmA').value = '';
            document.getElementById('searchSong').value = '';
            
            activeFilters = {};
            
            if (currentPlaylist === '8-track') {
                filteredData = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('8-Track');
                });
                apply8TrackOrdering();
            } else {
                filteredData = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('My Deck');
                });
            }
            
            renderSongTable();
            renderActiveFilters();
            updateClearButtonStyle();
        }

        function setupEventListeners() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    if (currentPlaylist === '8-track') return; // Disable sorting for 8-track playlist
                    const sortType = header.getAttribute('data-sort');
                    sortData(sortType);
                });
            });
            
            const filterElements = ['filterKey', 'filterArtist', 'filterYear', 'filterEmA'];
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterData);
                }
            });
            
            const searchElement = document.getElementById('searchSong');
            if (searchElement) {
                searchElement.addEventListener('input', filterData);
            }
            
            const clearFiltersBtn = document.getElementById('clearFilters');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clearAllFilters();
                });
            }
            
            const filterBtn = document.getElementById('filterBtn');
            const filterPanel = document.getElementById('filterPanel');
            if (filterBtn && filterPanel) {
                filterBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    filterPanel.style.display = filterPanel.style.display === 'block' ? 'none' : 'block';
                });
                
                filterPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            const playlistBtn = document.getElementById('playlistBtn');
            const playlistPanel = document.getElementById('playlistPanel');
            if (playlistBtn && playlistPanel) {
                playlistBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playlistPanel.style.display = playlistPanel.style.display === 'block' ? 'none' : 'block';
                });
                
                playlistPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            document.querySelectorAll('.playlist-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const playlist = e.target.getAttribute('data-playlist');
                    switchPlaylist(playlist);
                    playlistPanel.style.display = 'none';
                });
            });
            
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            setupAccountDropdown();
            
            document.addEventListener('click', () => {
                if (filterPanel) filterPanel.style.display = 'none';
                if (playlistPanel) playlistPanel.style.display = 'none';
                const accountPanel = document.getElementById('accountPanel');
                if (accountPanel) accountPanel.style.display = 'none';
            });
        }

        function switchPlaylist(playlist) {
            const playlistBtn = document.querySelector('.playlist-btn h1');
            currentPlaylist = playlist;
            
            // Hide detail card when switching playlists (fixes the bug)
            const detailCard = document.getElementById('detailCard');
            if (detailCard) {
                detailCard.classList.add('hidden');
            }
            
            if (playlist === '8-track') {
                playlistBtn.textContent = '8-Track';
                filteredData = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('8-Track');
                });
                
                apply8TrackOrdering();
                
                const controls = document.querySelector('.controls');
                if (controls) controls.style.display = 'none';
            } else {
                playlistBtn.textContent = 'My Deck';
                filteredData = songData.filter(song => {
                    const playlists = song.Playlists || '';
                    return playlists.includes('My Deck');
                });
                
                const controls = document.querySelector('.controls');
                if (controls) controls.style.display = 'flex';
            }
            
            clearAllFilters();
            renderSongTable();
            populateFilters();
        }

        function apply8TrackOrdering() {
            const trackOrder = [
                'Nocturne in D Minor',
                'All of Me', 
                'If I Aint Got You',
                'Tennessee Whiskey',
                'Hold Me',
                'Christmas Time Is Here',
                'Ode To Joyful',
                'Piano Sonata No. 14'
            ];
            
            filteredData.sort((a, b) => {
                const aIndex = trackOrder.indexOf(a.Title);
                const bIndex = trackOrder.indexOf(b.Title);
                
                if (aIndex !== -1 && bIndex !== -1) {
                    return aIndex - bIndex;
                }
                
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                
                return (a.Title || '').localeCompare(b.Title || '');
            });
        }

        function renderSongTable() {
            const tableBody = document.getElementById('songTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            filteredData.forEach((song, index) => {
                if (!song.Title && !song.Artist) return;
                
                const row = document.createElement('tr');
                row.onclick = () => showSongDetails(song);
                
                const clubCell = document.createElement('td');
                clubCell.className = 'club';
                
                if (currentPlaylist === '8-track') {
                    clubCell.textContent = (index + 1).toString();
                } else {
                    clubCell.textContent = getSuitSymbol(song.Index, song.Card) + ' ' + song.Card;
                }
                row.appendChild(clubCell);
                
                const infoCell = document.createElement('td');
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                
                // const titleDiv = document.createElement('div');
                // titleDiv.className = 'song-title';
                // titleDiv.textContent = song.Title || '';
                // songInfo.appendChild(titleDiv);
                
                // const artistDiv = document.createElement('div');
                // artistDiv.className = 'song-artist';
                // artistDiv.textContent = song.Artist || '';
                // songInfo.appendChild(artistDiv);
                const titleDiv = document.createElement('div');
                titleDiv.className = 'song-title';
                titleDiv.textContent = song.Title || '';
                songInfo.appendChild(titleDiv);
                
                const artistDiv = document.createElement('div');
                artistDiv.className = 'song-artist';
                artistDiv.textContent = song.Artist || '';
                songInfo.appendChild(artistDiv);
                
                // On mobile, add puzzle piece under artist
                if (window.innerWidth <= 768 && song["Puzzle Piece"]) {
                    const puzzleDiv = document.createElement('div');
                    puzzleDiv.className = 'song-puzzle';
                    puzzleDiv.textContent = song["Puzzle Piece"];
                    songInfo.appendChild(puzzleDiv);
                }
                
                infoCell.appendChild(songInfo);
                row.appendChild(infoCell);
                
                const puzzleCell = document.createElement('td');
                if (window.innerWidth > 768) {
                    puzzleCell.textContent = song["Puzzle Piece"] || '';
                }
                row.appendChild(puzzleCell);
                
                const keyCell = document.createElement('td');
                keyCell.textContent = song.Key || '';
                row.appendChild(keyCell);
                
                tableBody.appendChild(row);
            });
        }

        function showSongDetails(song) {
            
            function showSongDetails(song) {
            // Temporary debugging - remove after fixing
                console.log('Clicked song data:', song);
                console.log('Song Index:', song.Index, 'Title:', song.Title, 'Artist:', song.Artist, 'Key:', song.Key);
                
                // Continue with existing code...
                sortColumn = null;
                sortDirection = 'asc';
                updateSortIndicators();
                // ... rest of function
                const detailCard = document.getElementById('detailCard');
            }   

            sortColumn = null;
            sortDirection = 'asc';
            updateSortIndicators();
            
            const detailCard = document.getElementById('detailCard');
            if (!detailCard) return;
            
            detailCard.classList.remove('hidden');
            
            const notesHTML = convertNotesToLinks(song.Notes);
            
            let cardDisplay = '';
            if (currentPlaylist === '8-track') {
                const trackIndex = filteredData.findIndex(s => s.Index === song.Index) + 1;
                cardDisplay = `${trackIndex}`;
            } else {
                cardDisplay = `${getSuitSymbol(song.Index, song.Card)} ${song.Card}`;
            }
            
            detailCard.innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-top">
                        <div class="card-symbol">${cardDisplay}</div>
                        <div class="card-title">
                            <h2>${song.Title}</h2>
                            <p>${song.Artist}</p>
                        </div>
                        <div class="card-info">
                            <div>üîë ${song.Key}</div>
                            <div>üìÖ ${song.Date || ''}</div>
                            <div>‚ù§Ô∏è ${song.BPM || ''}</div>
                            <div class="ema-info">ü•Å ${song["Em&a"] || ''}</div>
                        </div>
                    </div>
                </div>
                <div class="detail-content">
                    ${song["Puzzle Piece"] ? `
                        <div class="puzzle-piece">
                            <div class="puzzle-icon">üß©</div>
                            <div>${song["Puzzle Piece"]}</div>
                        </div>
                    ` : ''}
                    ${song["Time Signature"] ? `<p>Time Signature: ${song["Time Signature"]}</p>` : ''}       
                    ${notesHTML ? `<div class="notes-links">${notesHTML}</div>` : ''}
                    <div id="documentViewer" class="document-viewer" style="display: none;"></div>
                </div>
            `;
            
            detailCard.scrollIntoView({ behavior: 'smooth' });
        }

        window.addEventListener('resize', () => {
            renderSongTable();
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            loadSongData();
        });
    </script>
</body>
</html>