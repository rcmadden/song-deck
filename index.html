<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <title>Song Deck</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 32px;
        }
        
        .header-icons {
            display: flex;
            gap: 20px;
        }
        
        .header-icon {
            font-size: 24px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            background-color: white;
        }
        
        tr {
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: left;
        }
        
        td.club {
            font-size: 20px;
        }
        
        .song-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .song-artist {
            font-style: italic;
            color: #666;
        }
        
        .detail-card {
            border: 1px solid #ddd;
            margin-bottom: 20px;
            background-color: white;
        }
        
        .detail-header {
            display: flex;
            background-color: #f9f9f9;
            padding: 15px 20px;
            align-items: center;
        }
        
        .card-symbol {
            font-size: 48px;
            margin-right: 20px;
        }
        
        .card-title {
            flex-grow: 1;
        }
        
        .card-title h2 {
            margin: 0 0 5px 0;
        }
        
        .card-title p {
            margin: 0;
            font-style: italic;
            color: #666;
        }
        
        .card-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-info div {
            margin-left: 10px;
            display: flex;
            align-items: center;
        }
        
        .detail-content {
            padding: 20px;
        }
        
        .detail-content p {
            margin: 0 0 10px 0;
        }
        
        .puzzle-piece {
            margin-top: 30px;
            display: flex;
            align-items: center;
        }
        
        .puzzle-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .hidden {
            display: none;
        }

        /* Style for notes links */
        .notes-links {
            margin-top: 15px;
        }
        
        .notes-links ul {
            list-style-type: disc;
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .notes-links li {
            margin: 5px 0;
        }
        
        .notes-links a {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .notes-links a:hover {
            color: #0056b3;
        }

        /* Document viewer styles */
        .document-viewer {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .document-viewer iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        
        .document-viewer img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .document-viewer .markdown-content {
            padding: 20px;
            background-color: #fafafa;
            font-family: Georgia, serif;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SONG</h1>
            <div class="header-icons">
                <div class="header-icon">üß©</div>
                <div class="header-icon">üîë</div>
            </div>
        </div>
        
        <table id="songTable">
            <tbody id="songTableBody">
                <!-- Table rows will be populated by JavaScript -->
            </tbody>
        </table>
        
        <div id="detailCard" class="detail-card hidden">
            <!-- Card details will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // This will store our song data
        let songData = [];
        
        // Function to get suit symbol based on card value
        function getSuitSymbol(card) {
            // Card can be a string or number
            if (typeof card === 'string') {
                return '‚ô£Ô∏è'; // Default to clubs for string values (A, J, Q, K)
            } else if (typeof card === 'number') {
                return '‚ô£Ô∏è'; // Clubs for number cards
            }
            return '‚ô£Ô∏è';
        }

        // Function to convert notes text to clickable links
        function convertNotesToLinks(notesText) {
            if (!notesText) return '';
            
            // Split multiple URLs by comma and space
            const parts = notesText.split(', ');
            const linkElements = [];
            const urls = [];
            
            parts.forEach(part => {
                part = part.trim();
                if (part.startsWith('http')) {
                    // Extract filename for better link text
                    const filename = part.split('/').pop();
                    // Remove file extension and replace underscores with spaces for display
                    const displayName = filename.replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                    linkElements.push(`<li><a href="#" onclick="loadDocument('${part}', '${filename}'); return false;">${displayName}</a></li>`);
                    urls.push(part);
                } else if (part) {
                    // Non-URL text (like "First Song by ear." or numbers)
                    linkElements.push(`<li>${part}</li>`);
                }
            });
            
            if (linkElements.length > 0) {
                return `<ul>${linkElements.join('')}</ul>`;
            }
            return '';
        }

        // Function to load and display document in the detail card
        function loadDocument(url, filename) {
            const documentViewer = document.getElementById('documentViewer');
            documentViewer.style.display = 'block';
            const fileExtension = filename.split('.').pop().toLowerCase();
            
            if (fileExtension === 'pdf') {
                // For PDFs, use an iframe
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            } else if (['png', 'jpg', 'jpeg', 'gif', 'svg'].includes(fileExtension)) {
                // For images, display directly
                documentViewer.innerHTML = `<img src="${url}" alt="${filename}" />`;
            } else if (fileExtension === 'md') {
                // For markdown files, fetch and display (basic rendering)
                fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        // Basic markdown to HTML conversion (you could use a proper markdown parser here)
                        const htmlContent = text
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/\n/g, '<br>');
                        
                        documentViewer.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
                    })
                    .catch(error => {
                        documentViewer.innerHTML = `<div class="markdown-content">Error loading document: ${error.message}</div>`;
                    });
            } else {
                // For other file types, try iframe
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            }
        }
              
        async function loadSongData() {
            try {
                const response = await fetch('songDB.csv');
                if (!response.ok) throw new Error('Network response was not ok');

                const csvText = await response.text();

                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                if (parsed.errors.length > 0) {
                    console.error('PapaParse errors:', parsed.errors);
                    throw new Error('Error parsing CSV');
                }

                songData = parsed.data;
                renderSongTable();
            } catch (error) {
                console.error('Error loading song data:', error);
                document.getElementById('songTableBody').innerHTML = `
                    <tr><td colspan="4">‚ö†Ô∏è Error loading song data.</td></tr>`;
            }
        }
        
        // Function to render the song table
        function renderSongTable() {
            const tableBody = document.getElementById('songTableBody');
            tableBody.innerHTML = '';
            
            songData.forEach(song => {
                if (!song.Title && !song.Artist) return; // Skip empty rows
                
                const row = document.createElement('tr');
                row.onclick = () => showSongDetails(song);
                
                const clubCell = document.createElement('td');
                clubCell.className = 'club';
                clubCell.textContent = getSuitSymbol(song.Card) + ' ' + song.Card;
                row.appendChild(clubCell);
                
                const infoCell = document.createElement('td');
                const titleDiv = document.createElement('div');
                titleDiv.className = 'song-title';
                titleDiv.textContent = song.Title || '';
                infoCell.appendChild(titleDiv);
                
                const artistDiv = document.createElement('div');
                artistDiv.className = 'song-artist';
                artistDiv.textContent = song.Artist || '';
                infoCell.appendChild(artistDiv);
                row.appendChild(infoCell);
                
                const puzzleCell = document.createElement('td');
                puzzleCell.textContent = song["Puzzle Piece"] || '';
                row.appendChild(puzzleCell);
                
                const keyCell = document.createElement('td');
                keyCell.textContent = song.Key || '';
                row.appendChild(keyCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to show song details
        function showSongDetails(song) {
            const detailCard = document.getElementById('detailCard');
            detailCard.classList.remove('hidden');
            
            // Convert notes to clickable links
            const notesHTML = convertNotesToLinks(song.Notes);
            
            // Format the card content
            detailCard.innerHTML = `
                <div class="detail-header">
                    <div class="card-symbol">${getSuitSymbol(song.Card)} ${song.Card}</div>
                    <div class="card-title">
                        <h2>${song.Title}</h2>
                        <p>${song.Artist}</p>
                    </div>
                    <div class="card-info">
                        <div>üîë ${song.Key}</div>
                        <div>üìÖ ${song.Date || ''}</div>
                        <div>‚ù§Ô∏è ${song.BPM || ''}</div>
                        <div class="ema-info">ü•Å ${song["Em&a"] || ''}</div>
                    </div>
                </div>
                <div class="detail-content">
                    ${song["Puzzle Piece"] ? `
                        <div class="puzzle-piece">
                            <div class="puzzle-icon">üß©</div>
                            <div>${song["Puzzle Piece"]}</div>
                        </div>
                    ` : ''}
                    ${song["Time Signature"] ? `<p>Time Signature: ${song["Time Signature"]}</p>` : ''}       
                    ${notesHTML ? `<div class="notes-links">${notesHTML}</div>` : ''}
                    <div id="documentViewer" class="document-viewer" style="display: none;"></div>
                </div>
            `;
            
            // Scroll to the detail card
            detailCard.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load CSV data
            loadSongData();
        });
    </script>
</body>
</html>