<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <title>Song Deck</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="playlist-dropdown">
                <button class="playlist-btn" id="playlistBtn">
                    <h1>My Deck</h1>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <div class="playlist-panel" id="playlistPanel">
                    <a href="#" class="playlist-option" data-playlist="my-deck">My Deck</a>
                    <a href="#" class="playlist-option" data-playlist="8-track">8-Track</a>
                </div>
            </div>
            <div class="header-icons">
                <div class="account-section" title="Account">
                    <div class="account-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="16" cy="16" r="15" stroke="currentColor" stroke-width="2"/>
                            <circle cx="16" cy="12" r="4" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 24c0-4.4 3.6-8 8-8s8 3.6 8 8" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="account-name">Russia M</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-dropdown">
                <button class="filter-btn" id="filterBtn" title="Filter">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h14M6 10h8M8 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <div class="filter-panel" id="filterPanel">
                    <select id="filterKey" class="filter-select">
                        <option value="">All Keys</option>
                    </select>
                    <select id="filterArtist" class="filter-select">
                        <option value="">All Artists</option>
                    </select>
                    <select id="filterYear" class="filter-select">
                        <option value="">All Years</option>
                    </select>
                    <select id="filterEmA" class="filter-select">
                        <option value="">All Em&A</option>
                    </select>
                    <input type="text" id="searchSong" placeholder="Search songs..." class="filter-input">
                    <button id="clearFilters" class="clear-filters-btn">Clear All Filters</button>
                </div>
            </div>
        </div>
        
        <table id="songTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="card"><span role="img" aria-label="Playing card">üÉè</span> <span class="sort-indicator">‚Üï</span></th>
                    <th class="sortable" data-sort="song">Song <span class="sort-indicator">‚Üï</span></th>
                    <th><span role="img" aria-label="Puzzle piece">üß©</span></th>
                    <th class="sortable" data-sort="key">üîë Key <span class="sort-indicator">‚Üï</span></th>
                </tr>
            </thead>
            <tbody id="songTableBody">
                <!-- Table rows will be populated by JavaScript -->
            </tbody>
        </table>
        
        <div id="detailCard" class="detail-card hidden">
            <!-- Card details will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // This will store our song data
        let songData = [];
        let filteredData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        
        // Function to get suit symbol based on index
        function getSuitSymbol(index, card) {
            // Handle Jokers (index 0 and 1)
            if (index <= 0) {
                return 'üÉè'; // Joker
            }
            
            // Calculate suit based on index
            // Index 2-14: Hearts (‚ô•Ô∏è)
            // Index 15-27: Spades (‚ô†Ô∏è) 
            // Index 28-40: Diamonds (‚ô¶Ô∏è)
            // Index 41-53: Clubs (‚ô£Ô∏è)
            
            if (index >= 1 && index <= 13) {
                return '‚ô£Ô∏è'; // Hearts
            } else if (index >= 14 && index <= 27) {
                return '‚ô¶Ô∏è'; // Spades
            } else if (index >= 2 && index <= 40) {
                return '‚ô†Ô∏è'; // Diamonds
            } else if (index >= 41 && index <= 53) {
                return '‚ô•Ô∏è'; // Clubs
            }
            
            return '‚ô£Ô∏è'; // Default fallback
        }

        // Function to convert notes text to clickable links
        function convertNotesToLinks(notesText) {
            if (!notesText) return '';
            
            // Split multiple URLs by comma and space
            const parts = notesText.split(', ');
            const linkElements = [];
            const urls = [];
            
            parts.forEach(part => {
                part = part.trim();
                if (part.startsWith('http')) {
                    // Extract filename for better link text
                    const filename = part.split('/').pop();
                    // Remove file extension and replace underscores with spaces for display
                    const displayName = filename.replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                    linkElements.push(`<li><a href="#" onclick="loadDocument('${part}', '${filename}'); return false;">${displayName}</a></li>`);
                    urls.push(part);
                } else if (part) {
                    // Non-URL text (like "First Song by ear." or numbers)
                    linkElements.push(`<li>${part}</li>`);
                }
            });
            
            if (linkElements.length > 0) {
                return `<ul>${linkElements.join('')}</ul>`;
            }
            return '';
        }

        // Function to load and display document in the detail card
        function loadDocument(url, filename) {
            const documentViewer = document.getElementById('documentViewer');
            documentViewer.style.display = 'block';
            const fileExtension = filename.split('.').pop().toLowerCase();
            
            if (fileExtension === 'pdf') {
                // For PDFs, use an iframe
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            } else if (['png', 'jpg', 'jpeg', 'gif', 'svg'].includes(fileExtension)) {
                // For images, display directly
                documentViewer.innerHTML = `<img src="${url}" alt="${filename}" />`;
            } else if (fileExtension === 'md') {
                // For markdown files, fetch and display (basic rendering)
                fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        // Basic markdown to HTML conversion (you could use a proper markdown parser here)
                        const htmlContent = text
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/\n/g, '<br>');
                        
                        documentViewer.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
                    })
                    .catch(error => {
                        documentViewer.innerHTML = `<div class="markdown-content">Error loading document: ${error.message}</div>`;
                    });
            } else {
                // For other file types, try iframe
                documentViewer.innerHTML = `<iframe src="${url}" title="${filename}"></iframe>`;
            }
        }
              
        async function loadSongData() {
            try {
                const response = await fetch('songDB.csv');
                if (!response.ok) throw new Error('Network response was not ok');

                const csvText = await response.text();

                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                if (parsed.errors.length > 0) {
                    console.error('PapaParse errors:', parsed.errors);
                    throw new Error('Error parsing CSV');
                }

                songData = parsed.data;
                filteredData = [...songData];
                populateFilters();
                renderSongTable();
                setupEventListeners();
            } catch (error) {
                console.error('Error loading song data:', error);
                document.getElementById('songTableBody').innerHTML = `
                    <tr><td colspan="4">‚ö†Ô∏è Error loading song data.</td></tr>`;
            }
        }
        
        // Function to sort data
        function sortData(column) {
            // If card column is clicked, clear other sorts
            if (column === 'card') {
                sortColumn = 'card';
                sortDirection = sortColumn === 'card' && sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
            }
            
            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'card') {
                    // Sort by Index (numeric)
                    aVal = parseInt(a.Index) || 0;
                    bVal = parseInt(b.Index) || 0;
                } else if (column === 'song') {
                    aVal = (a.Title || '').toLowerCase();
                    bVal = (b.Title || '').toLowerCase();
                } else if (column === 'key') {
                    aVal = (a.Key || '').toLowerCase();
                    bVal = (b.Key || '').toLowerCase();
                } else if (column === 'artist') {
                    aVal = (a.Artist || '').toLowerCase();
                    bVal = (b.Artist || '').toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            updateSortIndicators();
            renderSongTable();
        }
        
        // Function to update sort indicators
        function updateSortIndicators() {
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '‚Üï';
                indicator.style.opacity = '0.5';
            });
            
            if (sortColumn) {
                const activeHeader = document.querySelector(`[data-sort="${sortColumn}"] .sort-indicator`);
                if (activeHeader) {
                    activeHeader.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                    activeHeader.style.opacity = '1';
                }
            }
        }
        
        // Function to populate filter dropdowns
        function populateFilters() {
            const keys = [...new Set(songData.map(song => song.Key || '').filter(key => key))].sort();
            const artists = [...new Set(songData.map(song => song.Artist || '').filter(artist => artist))].sort();
            const years = [...new Set(songData.map(song => String(song.Date || '')).filter(date => date))].sort();
            const emAs = [...new Set(songData.map(song => song['Em&a'] || '').filter(ema => ema))].sort();
            
            // Populate Key filter
            const keySelect = document.getElementById('filterKey');
            keySelect.innerHTML = '<option value="">All Keys</option>';
            keys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                keySelect.appendChild(option);
            });
            
            // Populate Artist filter
            const artistSelect = document.getElementById('filterArtist');
            artistSelect.innerHTML = '<option value="">All Artists</option>';
            artists.forEach(artist => {
                const option = document.createElement('option');
                option.value = artist;
                option.textContent = artist;
                artistSelect.appendChild(option);
            });
            
            // Populate Year filter
            const yearSelect = document.getElementById('filterYear');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Populate Em&A filter
            const emASelect = document.getElementById('filterEmA');
            emASelect.innerHTML = '<option value="">All Em&A</option>';
            emAs.forEach(ema => {
                const option = document.createElement('option');
                option.value = ema;
                option.textContent = ema;
                emASelect.appendChild(option);
            });
        }
        
        // Function to filter data
        function filterData() {
            const keyFilter = document.getElementById('filterKey').value;
            const artistFilter = document.getElementById('filterArtist').value;
            const yearFilter = document.getElementById('filterYear').value;
            const emAFilter = document.getElementById('filterEmA').value;
            const searchFilter = document.getElementById('searchSong').value.toLowerCase();
            
            filteredData = songData.filter(song => {
                const keyMatch = !keyFilter || (song.Key || '') === keyFilter;
                const artistMatch = !artistFilter || (song.Artist || '') === artistFilter;
                // Convert both to strings for comparison since Date might be a number
                const yearMatch = !yearFilter || String(song.Date || '') === yearFilter;
                const emAMatch = !emAFilter || (song['Em&a'] || '') === emAFilter;
                // Search in both title and artist
                const searchMatch = !searchFilter || 
                    (song.Title || '').toLowerCase().includes(searchFilter) ||
                    (song.Artist || '').toLowerCase().includes(searchFilter);
                
                return keyMatch && artistMatch && yearMatch && emAMatch && searchMatch;
            });
            
            renderSongTable();
            updateClearButtonStyle();
        }
        
        // Function to check if any filters are active
        function hasActiveFilters() {
            return document.getElementById('filterKey').value !== '' ||
                   document.getElementById('filterArtist').value !== '' ||
                   document.getElementById('filterYear').value !== '' ||
                   document.getElementById('filterEmA').value !== '' ||
                   document.getElementById('searchSong').value !== '';
        }
        
        // Function to update clear button styling
        function updateClearButtonStyle() {
            const clearButton = document.getElementById('clearFilters');
            if (hasActiveFilters()) {
                clearButton.classList.add('has-filters');
            } else {
                clearButton.classList.remove('has-filters');
            }
        }
        
        // Function to clear all filters
        function clearAllFilters() {
            document.getElementById('filterKey').value = '';
            document.getElementById('filterArtist').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterEmA').value = '';
            document.getElementById('searchSong').value = '';
            
            // Reset to show all data
            filteredData = [...songData];
            renderSongTable();
            updateClearButtonStyle();
        }
        
        // Function to setup event listeners
        function setupEventListeners() {
            // Sort functionality
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortType = header.getAttribute('data-sort');
                    sortData(sortType);
                });
            });
            
            // Filter functionality
            document.getElementById('filterKey').addEventListener('change', filterData);
            document.getElementById('filterArtist').addEventListener('change', filterData);
            document.getElementById('filterYear').addEventListener('change', filterData);
            document.getElementById('filterEmA').addEventListener('change', filterData);
            document.getElementById('searchSong').addEventListener('input', filterData);
            
            // Clear filters functionality
            document.getElementById('clearFilters').addEventListener('click', (e) => {
                e.stopPropagation();
                clearAllFilters();
            });
            
            // Filter dropdown
            document.getElementById('filterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('filterPanel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            });
            
            // Playlist dropdown
            document.getElementById('playlistBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('playlistPanel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            });
            
            // Playlist options
            document.querySelectorAll('.playlist-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const playlist = e.target.getAttribute('data-playlist');
                    switchPlaylist(playlist);
                    document.getElementById('playlistPanel').style.display = 'none';
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.getElementById('filterPanel').style.display = 'none';
                document.getElementById('playlistPanel').style.display = 'none';
            });
        }
        
        // Function to switch playlists
        function switchPlaylist(playlist) {
            const playlistBtn = document.querySelector('.playlist-btn h1');
            if (playlist === '8-track') {
                playlistBtn.textContent = '8-Track';
                // Here you would load 8-Track data - for now just show message
                document.getElementById('songTableBody').innerHTML = `
                    <tr><td colspan="4">üéµ 8-Track playlist coming soon...</td></tr>`;
            } else {
                playlistBtn.textContent = 'My Deck';
                // Reset to original data
                filteredData = [...songData];
                renderSongTable();
            }
        }
        
        // Function to render the song table
        function renderSongTable() {
            const tableBody = document.getElementById('songTableBody');
            tableBody.innerHTML = '';
            
            filteredData.forEach(song => {
                if (!song.Title && !song.Artist) return; // Skip empty rows
                
                const row = document.createElement('tr');
                row.onclick = () => showSongDetails(song);
                
                const clubCell = document.createElement('td');
                clubCell.className = 'club';
                clubCell.textContent = getSuitSymbol(song.Index, song.Card) + ' ' + song.Card;
                row.appendChild(clubCell);
                
                const infoCell = document.createElement('td');
                const titleDiv = document.createElement('div');
                titleDiv.className = 'song-title';
                titleDiv.textContent = song.Title || '';
                infoCell.appendChild(titleDiv);
                
                const artistDiv = document.createElement('div');
                artistDiv.className = 'song-artist';
                artistDiv.textContent = song.Artist || '';
                infoCell.appendChild(artistDiv);
                row.appendChild(infoCell);
                
                const puzzleCell = document.createElement('td');
                puzzleCell.textContent = song["Puzzle Piece"] || '';
                row.appendChild(puzzleCell);
                
                const keyCell = document.createElement('td');
                keyCell.textContent = song.Key || '';
                row.appendChild(keyCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to show song details
        function showSongDetails(song) {
            // Clear any active sort when card is clicked
            sortColumn = null;
            sortDirection = 'asc';
            updateSortIndicators();
            
            const detailCard = document.getElementById('detailCard');
            detailCard.classList.remove('hidden');
            
            // Convert notes to clickable links
            const notesHTML = convertNotesToLinks(song.Notes);
            
            // Format the card content
            detailCard.innerHTML = `
                <div class="detail-header">
                    <div class="card-symbol">${getSuitSymbol(song.Card)} ${song.Card}</div>
                    <div class="card-title">
                        <h2>${song.Title}</h2>
                        <p>${song.Artist}</p>
                    </div>
                    <div class="card-info">
                        <div>üîë ${song.Key}</div>
                        <div>üìÖ ${song.Date || ''}</div>
                        <div>‚ù§Ô∏è ${song.BPM || ''}</div>
                        <div class="ema-info">ü•Å ${song["Em&a"] || ''}</div>
                    </div>
                </div>
                <div class="detail-content">
                    ${song["Puzzle Piece"] ? `
                        <div class="puzzle-piece">
                            <div class="puzzle-icon">üß©</div>
                            <div>${song["Puzzle Piece"]}</div>
                        </div>
                    ` : ''}
                    ${song["Time Signature"] ? `<p>Time Signature: ${song["Time Signature"]}</p>` : ''}       
                    ${notesHTML ? `<div class="notes-links">${notesHTML}</div>` : ''}
                    <div id="documentViewer" class="document-viewer" style="display: none;"></div>
                </div>
            `;
            
            // Scroll to the detail card
            detailCard.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load CSV data
            loadSongData();
        });
    </script>
</body>
</html>